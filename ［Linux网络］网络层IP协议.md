@[TOC]

# IP协议基本概念
在生活中我们做一件事时，是需要解决两个问题的，分别是**决策问题和执行问题**，比如公司在完成一个项目时，需要产品经理做决策诠释项目雏形，工程师执行产品经理的决策。**而在网络中，传输层的TCP协议提供可靠传输，为数据的传输做决策，提出一系列传输策略，比如确认应答机制，超时重传机制等等，保证数据的可靠传输，而网络层的IP协议执行TCP协议的决策，较大概率的将数据从一个主机传输到另一个主机，所以IP协议并不提供可靠性机制。IP协议的作用是在复杂的网络环境中确定一个合适的路径进行数据传输。**


![在这里插入图片描述](https://img-blog.csdnimg.cn/669d9ae5ac1249a8ab59b3601c81bbd1.png)

---

# IP协议格式

IP协议格式如下：
![在这里插入图片描述](https://img-blog.csdnimg.cn/baf5b74aa50f44fc8d2f08cc07ff33a7.png)

- **4位版本号(version):** 指定IP协议的版本, 对于IPv4来说, 该字段就是4，对于IPv6来说，该字段就是6
- **4位首部长度(header length):** 该字段表示IP协议报头的长度，该字段总共4位，取值范围为0000 ~ 1111，真正的首部长度为该字段的值×4，比如该字段二进制表示1010，十进制为10，IP协议报头的长度就为 10×4=40，总共位40字节
- **8位服务类型(Type Of Service):** 3位优先权字段(已经弃用), 4位TOS字段, 和1位保留字段(必须置为0). 4位TOS分别表示: 最小延时, 最大吞吐量, 最高可靠性, 最小成本. 这四者相互冲突, 只能选择一个. 对于ssh/telnet这样的应用程序, 最小延时比较重要; 对于ftp这样的程序, 最大吞吐量比较重要
- **16位总长度(total length):** IP数据报整体占多少个字节. 总长度 = 报头 + 有效载荷
- **16位标识(id):** 唯一的标识主机发送的报文，如果数据在IP层进行了分片，那么每一个分片对应的id都是相同的。
- **3位标志字段**：第一位保留，表示暂时没有规定该字段的意义。第二位表示禁止分片，表示如果报文长度超过MTU，IP模块就会丢弃该报文。第三位表示“更多分片”，如果报文没有进行分片，则该字段设置为0，如果报文进行了分片，则除了最后一个分片报文设置为0以外，其余分片报文均设置为1。
- **13位片偏移(framegament offset):** 分片相对于原始数据开始处的偏移，表示当前分片在原数据中的偏移位置，实际偏移的字节数是这个值× 8 得到的。因此除了最后一个报文之外，其他报文的长度必须是8的整数倍，否则报文就不连续了。

- **8位生存时间(Time To Live, TTL):** 数据报到达目的地的最大报文跳数. 一般是64. 每次经过一个路由, TTL-= 1, 一直减到0还没到达, 那么就丢弃了. 这个字段主要是用来防止出现路由循环


**IP协议是如何进行分离报头和有效载荷的？**

当IP协议获取到一个报文，因为IP协议报头的基础长度为20字节，所以首先读取报文的前20字节，再读取4位首部长度字段，将数值×4为真正的首部长度，首部长度减去20字节，就是IP协议的选项长度，其他的剩余的长度就为有效载荷。

**IP协议如何分用，向上交付？**

在IP报头当中有一个字段叫做8位协议，该字段表示的就是上层协议的类型，IP就是根据该字段判定应该将分离出来的有效载荷交付给上层的哪一个协议的。该字段是发送方的IP层从上层传输层获取到数据后填充的，比如是上层TCP交给IP层的数据，那么该数据在封装IP报头时的8位协议填充的就是TCP对应的编号。

---

# IP协议的分片和组装

用户发送数据经过应用层发送到传输层，由传输层发送到网络层，再由网络层发送到数据链路层，再由数据链路层经由网络发送到对端，**数据链路层一次可以网络发送的数据是有限的，这个限制值称为MTU（最大传输单元），不同的网络类型有不同的MTU，由于数据链路层MTU的限制, 对于超过MTU的IP数据包要进行分片。**


<br>


```ipconfig```指令可以查看当前MTU的值：

![在这里插入图片描述](https://img-blog.csdnimg.cn/16a3b8ea64bb495b8e1a161fdfb8e949.png)
如果IP层要传送的数据超过了1500字节，那么就需要先在IP层对该数据进行分片，然后再将分片后的数据交给数据链路层进行发送，**每个分片后的包都需要有报头，报头中16位总长度为分片后报文的长度。**


![在这里插入图片描述](https://img-blog.csdnimg.cn/d61a044f32e047f098b8d616f533beb2.png)

**假设数据链路层规定的MTU为1500，网络层有一个1500字节的报文要向下交付：**

 1. 首先网络层1500字节+IP协议报头20字节 = 1520字节，超过MTU1500字节，无法向下交付，需要分片
 2. 每个有效载荷+IP协议报头的最大值为1500字节，所以分片后每个包有效载荷的最大值为1500字节减去IP协议报头20字节等于1480，所以网络层有效载荷1500字节被分为1480和20两个包
 3. 1480和20两个包都需要添加上IP协议报头向下交付

![在这里插入图片描述](https://img-blog.csdnimg.cn/dd5e2548894c4884a3f97cbd798d608c.png)

:grey_question: 分片后的数据交付给数据链路层，数据链路层交付给网络，网络又交付给对端的数据链路层，再交付给网络层，**那么分片后的数据是由谁来组装的呢？又是如何组装的呢？**

- 报文是由发送方的网络层IP协议进行分片的，而**报文的组装也是由接收方的网络层的IP协议进行组装的。**

:grey_question:   **如何组装？**

IP协议的报头有三个字段，**16位标识(id)、3位标志字段和13位片偏移**，组装的工作由这三个字段协作完成。

- **16位标识**：如果报文没有进行分片，不同的报文的16位标识是不一样的，如果报文进行了分片，之前隶属于同一个报文的分片后的报文的16位标识是一样的
- **3位标识字段**：3位标识字段的第1位保留，表示暂时没有规定该字段的意义；3位标识字段的第2位表示禁止分片，表示如果该报文超过MTU时，网络层的IP协议就会丢弃该报文；**3位标识字段的第3位表示更多分片，如果报文没有进行分片，该位为0；如果报文进行了分片，该位为1表示该分片报文的后面还有其他报文，该位为0表示该分片报文是最后一块报文**
- **13位片偏移**：表示分片的报文在原始报文的偏移量

**组装的过程：**

- 将所有16标识字段相同的分片报文按照13位片偏移字段进行升序排序
- 找到13位片偏移为0的分片报文，这个报文为组装报文的开头，读取报文的16位总长度，16位总长度+13位片偏移为下一块分片报文的13位片偏移的值，以此类推
- 直到组装到13片偏移不为0，而3位标识字段的第3位更多分片字段为0的分片报文，表示组装完成



:grey_question: **分片报文丢包了怎么办？**

分片后的报文在网络传输过程中也可能会出现丢包问题，但接收端网络层IP协议有能力判断是否收到了全部分片报文。

- **开头报文丢包**：接收端网络层IP协议找不到16位标识相同，13片偏移为0的报文
- **结尾报文丢包**：接收端网络层IP协议找不到16位标识相同，3位标识字段第3位字段为0的报文
- **中间报文丢包**：在组装过程中，当前报文16总长度+13位片偏移为下一个报文片偏移的值，如果找不到，则表示中间报文丢失

:grey_question: **注意：没有进行分片的报文的3位标识字段的更多分片字段为0，最后一个分片报文的3位标识字段的更多分片字段也为0，如何分辨这两个报文呢？**

虽然这两个报文的3位标识字段的更多分片字段都为0，但是没有进行分片的报文的13位片偏移的值为0，而最后一个分片报文的13位片偏移不可能为0.

**在网络中，分片和组装是小概率的情况，分片和组装会增加网络中的丢包率**，只要在收到所有分片报文，接收端才认为完整接受了该报文，如果众多的分片报文中有一个丢包了，接收端就不认为完整接收了该报文，此时就需要发送方重发该报文，这就提高了网络中的丢包率。


:grey_question: **那么既然分片是有风险的，怎么减少或避免分片呢？**

造成分片的本质是网络层一次性发送给数据链路层的数据太多，**TCP作为可靠的传输控制协议，TCP协议可以限制一次发送的数据在某个范围之内，这个值称为MSS（Maximum Segment Size，最大报文段长度），MSS是基于MTU限定出来的。**

:grey_question: **MSS是如何限定出来的呢？**

实际上TCP协议在建立连接进行三次握手的时候，不仅仅会相互协商窗口大小等以外，还需要协商MSS最大报文段长度，由于不同网络类型的MTU有可能不同，MSS的值也有可能不一样，所以最终的MSS值为接收方和发送方MSS的较小值。

![在这里插入图片描述](https://img-blog.csdnimg.cn/5ea40137a49a4e9d826741f49ee639ff.png)

---

# 网段划分

IP地址由网络号和主机号两部分构成：

- 网络号：保证相互连接的两个网段具有不同的标识。
- 主机号：同一网段内，主机之间具有相同的网络号，但是必须有不同的主机号。



![在这里插入图片描述](https://img-blog.csdnimg.cn/db782e11a68941249b66f86a0f286583.png)

 - 不同的子网其实就是把网络号相同的主机放到一起.
 - 如果在子网中新增一台主机, 则这台主机的网络号和这个子网的网络号一致, 但是主机号必须不能和子网中的其他主机重复.

通过合理设置主机号和网络号, 就可以保证在相互连接的网络中, 每台主机的IP地址都不相同。有一种技术叫做DHCP，能够自动的给子网内新增主机节点分配IP地址，避免了手动管理IP的不便.

一般的路由器都带有DHCP功能。 因此路由器也可以看做一个DHCP服务器。过去曾经提出一种划分网络号和主机号的方案, 把所有IP 地址分为五类, 如下图所示：

![在这里插入图片描述](https://img-blog.csdnimg.cn/5104d765cfd34f5a9c754a413c6a8a43.png)

 - A类 0.0.0.0到 127.255.255.255 
 - B类 128.0.0.0到191.255.255.255
 - C类 192.0.0.0到 223.255.255.255
 - D类 224.0.0.0到 239.255.255.255
 - E类 240.0.0.0到247.255.255.255

随着Internet的飞速发展,这种划分方案的局限性很快显现出来,大多数组织都申请B类网络地址, 导致B类地址很快就分配完了, 而A类却浪费了大量地址

 - 例如, 申请了一个B类地址, 理论上一个子网内能允许6万5千多个主机. A类地址的子网内的主机数更多.
 - 然而实际网络架设中, 不会存在一个子网内有这么多的情况. 因此大量的IP地址都被浪费掉了.


**针对这种情况提出了新的划分方案, 称为CIDR(Classless Interdomain Routing)**
 - 引入一个额外的子网掩码(subnet mask)来区分网络号和主机号;
 - 子网掩码也是一个32位的正整数. 通常用一串 "0" 来结尾;
 - 将IP地址和子网掩码进行 "按位与" 操作, 得到的结果就是网络号;
 - 网络号和主机号的划分与这个IP地址是A类、B类还是C类无关;

![在这里插入图片描述](https://img-blog.csdnimg.cn/54b21678c78e4ab096e2b43269dd5c6f.png)
可见,IP地址与子网掩码做与运算可以得到网络号, 主机号从全0到全1就是子网的地址范围;

**IP地址和子网掩码还有一种更简洁的表示方法,例如140.252.20.68/24,表示IP地址为140.252.20.68, 子网掩码的高24位是1,也就是255.255.255.0**


---

# 特殊的IP地址
- 将IP地址中的主机地址全部设为0, 就成为了网络号, 代表这个局域网;
- 将IP地址中的主机地址全部设为1, 就成为了广播地址, 用于给同一个链路中相互连接的所有主机发送数据包;
- 127.*的IP地址用于本机环回(loop back)测试,通常是127.0.0.1


![在这里插入图片描述](https://img-blog.csdnimg.cn/967170b743754fc0b529b7327d94b206.png)

---

# 私有IP地址和公网IP地址

如果一个组织内部组建局域网,IP地址只用于局域网内的通信,而不直接连到Internet上,理论上 使用任意的IP地址都可以,但是RFC 1918规定了用于组建局域网的私有IP地址：

 - 10.*,前8位是网络号,共16,777,216个地址
 - 172.16.到172.31.,前12位是网络号,共1,048,576个地址
 - 192.168.*,前16位是网络号,共65,536个地址
包含在这个范围中的, 都成为私有IP, 其余的则称为全局IP(或公网IP);

![在这里插入图片描述](https://img-blog.csdnimg.cn/1909edd645ac4386acf331093bc40eb5.png)

 - 一个路由器可以配置两个IP地址, 一个是WAN口IP, 一个是LAN口IP(子网IP).
 - 路由器LAN口连接的主机, 都从属于当前这个路由器的子网中.
 - 不同的路由器, 子网IP其实都是一样的(通常都是192.168.1.1). 子网内的主机IP地址不能重复. 但是子网之间的IP地址就可以重复了.
 - 每一个家用路由器, 其实又作为运营商路由器的子网中的一个节点. 这样的运营商路由器可能会有很多级, 最外层的运营商路由器, WAN口IP就是一个公网IP了.
 - 子网内的主机需要和外网进行通信时, 路由器将IP首部中的IP地址进行替换(替换成WAN口IP), 这样逐级替换, 最终数据包中的IP地址成为一个公网IP. 这种技术称为NAT(Network Address Translation，网络地址转换).

:grey_question:  **运营商问题**

我们在访问抖音，快手或者bilibili这些视频软件时，我们是在使用各大互联网公司的服务，那为什么我们缴交流量费用是交给三大运营商而不是互联网公司呢？

这本质上涉及到网络世界的基础设施问题，实现网络通信的基础设施是由三大运营商构建的，我们访问软件服务器的时候，实际上是将数据经由三大运营商搭建的基础设施的基站，路由器等设施进行转发的，最终的访问请求才能到达互联网公司的服务器，互联网公司软件的响应数据一样的也需要经由这一过程才能发送到用户手中，所以我们需要向建设基础设施的三大运营商缴费，这就好比我们在开车经过高速公路需要缴交高速费一个道理。

<br>








**查看云服务器的公网IP：**

![在这里插入图片描述](https://img-blog.csdnimg.cn/f6cfa7ceb4f348f2ad6e3445c5907693.png)

**`ifconfig`查看云服务器的私网IP：**


![在这里插入图片描述](https://img-blog.csdnimg.cn/dd4ec1988dce41deb06d83c511b4cfb7.png)
:grey_question:  **私网IP能不能出现在公网中，为什么？**

- 不同局域网中的私有IP有可能是相同的，这就与**IP地址唯一标识网络中的一台主机**相矛盾


---


# 路由
路由的过程, 就是这样一跳一跳(Hop by Hop) "问路" 的过程.
所谓 "一跳" 就是数据链路层中的一个区间. 具体在以太网中指从源MAC地址到目的MAC地址之间的帧传输区间.


![在这里插入图片描述](https://img-blog.csdnimg.cn/e712bbb2772d4ac594e40e9ccb95147a.png)
IP数据包的传输过程也和问路一样.
- 当IP数据包, 到达路由器时, 路由器会先查看目的IP;
- 路由器决定这个数据包是能直接发送给目标主机, 还是需要发送给下一个路由器;
- 依次反复, 一直到达目标IP地址;

:grey_question: **那么如何判定当前这个数据包该发送到哪里呢?** 

这个就依靠每个节点内部维护一个路由表。

![在这里插入图片描述](https://img-blog.csdnimg.cn/43fa3fcd527a4dc1a7ee6151d34c4925.png)

**`route`查看主机路由表**

![在这里插入图片描述](https://img-blog.csdnimg.cn/6b8c0243973247ed9d434be93a73f2fb.png)

 - 路由表的`Destination`是目的网络地址
 - `Genmask`是子网掩码
 - `Gateway`是下一跳地址
 - `Iface`是发送接口
 - `Flags`中的U标志表示此条目有效(可以禁用某些 条目),G标志表示此条目的下一跳地址是某个路由器的地址,没有G标志的条目表示目的网络地址是与本机接口直接相连的网络,不必经路由器转发


**转发过程：**

1. 当报文到达路由器时，路由器会目的IP与子网掩码`Genmask`按位与得出目的IP的网络号
2. 将目的IP的网络号与`Destination`进行校验，如果匹配则前往下一跳`Iface`
3. 如果不匹配则重复校验其他条目，如果没有找到匹配的网络号，路由表则会将该报文转发到默认下一跳`default`



**对比网络层和数据链路层：**

 - 网络层所做的工作是路由选择即数据下一跳的目的地的选择
 - 数据链路层所做的工作是实现数据转发下一跳的过程





---

# 路由表生成算法
路由可分为静态路由和动态路由：

- 静态路由：是指由网络管理员手工配置路由信息。
- 动态路由：是指路由器能够通过算法自动建立自己的路由表，并且能够根据实际情况进行调整。

路由表相关生成算法：距离向量算法、LS算法、Dijkstra算法等。

---
